- hosts: iaas-node
  become: true
  become_user: root
  user: ubuntu
  tasks:
  - name: Install packages
    apt: name={{item}} state=present update_cache=yes
    with_items:
      - nova-compute
      - neutron-linuxbridge-agent
  - name: copy nova.conf
    template:
      src: nova/nova.conf
      dest: /etc/nova/nova.conf
      owner: root
      group: root
      mode: '0644'
  - name: Set my ip address
    shell: MY_IP=`ifconfig | grep "inet addr:192.168" | awk '{print $2}' | awk -F: '{print $2}'`; sed -i s/"my_ip = 192.168.1.100"/"my_ip = $MY_IP"/ /etc/nova/nova.conf
  - name: copy neutron.conf
    template:
      src: neutron/neutron.conf
      dest: /etc/neutron/neutron.conf
      owner: root
      group: root
      mode: '0644'
  - name: copy linuxbridge_agent.ini
    template:
      src: neutron/linuxbridge_agent.ini
      dest: /etc/neutron/plugins/ml2/linuxbridge_agent.ini
      owner: root
      group: root
      mode: '0644'
  - name: reboot
    shell: sleep 2 && shutdown -r now
    async: 1
    poll: 0
    ignore_errors: true
